<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel年份统计工具</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        body {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        button {
            padding: 10px;
            cursor: pointer;
        }
        #result {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Excel年份统计工具</h2>
        <input type="file" id="fileInput" accept=".xlsx,.xls">
        <button onclick="analyzeFile()">统计</button>
        <button onclick="exportToExcel()" id="exportBtn" style="display: none;">导出结果</button>
        <div id="result"></div>
    </div>

    <script>
        let yearStats = {};

        function analyzeFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请先选择Excel文件！');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                
                // 获取第一个工作表
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                // 修改读取选项，确保正确读取日期格式
                const jsonData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 'A',
                    raw: false,  // 以字符串形式读取所有值
                    dateNF: 'yyyy/m/d'  // 指定日期格式
                });

                // 重置统计数据
                yearStats = {};

                // 查找申请日列的索引
                let applicationDateKey = null;
                const firstRow = jsonData[0];
                for (let key in firstRow) {
                    if (firstRow[key] && firstRow[key].toString().includes('申请日')) {
                        applicationDateKey = key;
                        break;
                    }
                }

                if (!applicationDateKey) {
                    alert('未找到申请日列！');
                    return;
                }

                // 从第二行开始统计年份（跳过表头）
                jsonData.slice(1).forEach(row => {
                    if (row[applicationDateKey]) {
                        let dateStr = row[applicationDateKey].toString();
                        // 匹配 YYYY/M/D 格式的日期
                        const match = dateStr.match(/(\d{4})[/\-]\d{1,2}[/\-]\d{1,2}/);
                        if (match) {
                            const year = parseInt(match[1]);
                            if (year >= 1000 && year <= 9999) {
                                yearStats[year] = (yearStats[year] || 0) + 1;
                            }
                        }
                    }
                });

                displayResults();
                document.getElementById('exportBtn').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        }

        function displayResults() {
            const resultDiv = document.getElementById('result');
            let html = '<table><tr><th>年份</th><th>出现次数</th></tr>';
            
            Object.keys(yearStats)
                .sort((a, b) => a - b)
                .forEach(year => {
                    html += `<tr><td>${year}</td><td>${yearStats[year]}</td></tr>`;
                });
            
            html += '</table>';
            resultDiv.innerHTML = html;
        }

        function exportToExcel() {
            // 创建工作表数据
            const data = [['年份', '出现次数']];
            Object.keys(yearStats)
                .sort((a, b) => a - b)
                .forEach(year => {
                    data.push([year, yearStats[year]]);
                });

            // 创建工作簿
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "统计结果");

            // 导出文件
            XLSX.writeFile(wb, "年份统计结果.xlsx");
        }
    </script>
</body>
</html>